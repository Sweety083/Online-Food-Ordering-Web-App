pipeline {
    agent any

    environment {
        KUBE_NAMESPACE = 'production'
        SERVICE_NAME  = 'food-ordering-service'
        BLUE_DEPLOY   = 'food-ordering-blue'
        GREEN_DEPLOY  = 'food-ordering-green'
        IMAGE_NAME    = 'sweetyraj22/food-ordering-app'
        IMAGE_TAG     = "latest"
    }

    stages {

        stage('Checkout') {
            steps {
                git 'https://github.com/Sweety083/Online-Food-Ordering-Web-App.git'
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
                    sh "docker push ${IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }

        stage('Deploy Green Version') {
            steps {
                script {
                    // Apply green deployment
                    sh "kubectl apply -f k8s/deployment-green.yaml -n ${KUBE_NAMESPACE} --validate=false"
                }
            }
        }

        stage('Verify Green Pods') {
            steps {
                script {
                    // Wait until green pods are ready
                    sh """
                    kubectl rollout status deployment/${GREEN_DEPLOY} -n ${KUBE_NAMESPACE}
                    """
                }
            }
        }

        stage('Switch Traffic to Green') {
            steps {
                script {
                    // Patch service to point to green pods
                    sh """
                    kubectl patch svc ${SERVICE_NAME} -n ${KUBE_NAMESPACE} -p '{"spec":{"selector":{"app":"food-ordering","version":"green"}}}'
                    """
                }
            }
        }

        stage('Optional: Remove Blue Deployment') {
            steps {
                script {
                    // Delete old blue deployment
                    sh "kubectl delete deployment ${BLUE_DEPLOY} -n ${KUBE_NAMESPACE} || true"
                }
            }
        }
    }

    post {
        success {
            echo "✅ Blue-Green deployment successful. Service now points to GREEN version!"
        }
        failure {
            echo "❌ Deployment failed. Check logs!"
        }
    }
}
